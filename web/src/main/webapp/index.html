<html>
<script src="js/jquery/jquery.min.js"></script>
<script>
    var ORDER_STATUS_ENUM = ["ACTIVE","SCHEDULED","COMPLETED","PICKED_UP"];
    var GENDER_ENUM = ["MAN","FEMALE"];
    var GARMENT_TYPE_ENUM = ["COAT",/*"PANTS","VEST","SHIRT","OVERCOAT","LEATHER","SKIRT",*/"DRESS"/*,"SHORTS","SKORT","SLACKS"*/];

    function getRandomName(callback) {
        jQuery.ajax({
            type: 'GET',
            'url': "words",
            dataType: "text",
            'success': function(wordsList) {
                var wordListArray = wordsList.split(/\n/);
                callback(wordListArray);
            }
        });
    }

    function ISODateString(d){
        function pad(n){return n<10 ? '0'+n : n}
        return d.getUTCFullYear()+'-'
                + pad(d.getUTCMonth()+1)+'-'
                + pad(d.getUTCDate())+'T'
                + pad(d.getUTCHours())+':'
                + pad(d.getUTCMinutes())+':'
                + pad(d.getUTCSeconds())+'Z'}

    $.postJSON = function(url, data, callback) {
        return jQuery.ajax({
            type: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            'url': url,
            'data': JSON.stringify(data),
            'dataType': 'json',
            'success': callback
        });
    };

    $.getJSON = function(url, callback) {
        return jQuery.ajax({
            type: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            'url': url,
            'dataType': 'json',
            'success': callback
        });
    };

    var orderDetails = undefined;
    var token = undefined;

    function createOrderDetail() {

        getRandomName(function(wordListArray){
            var orderId = Math.random()*10000;
            var today = new Date();
            var dueDate = new Date();
            dueDate.setDate(today.getDate()+Math.floor(Math.random()*400));
            var price = Math.random()*1000;
            price = price.toFixed(2);
            var firstName = wordListArray[Math.floor(Math.random()*wordListArray.length)];
            var lastName = wordListArray[Math.floor(Math.random()*wordListArray.length)];
            var orderStatus = ORDER_STATUS_ENUM[Math.floor(Math.random()*ORDER_STATUS_ENUM.length)];
            var gender = GENDER_ENUM[Math.floor(Math.random()*GENDER_ENUM.length)];
            $.postJSON("webresources/order/create/" + token, {"firstName":firstName,"lastName":lastName,"gender":gender,"email":"demo@demo.com","contactPreferences":"PHONE","phoneNumber":"1234567891"}, function(orderDetail) {
                var createdOrder = orderDetail.data;
                $("#lastCreatedId").text("Last Created Order ID:" +orderDetail.data.orderId);
                var garment = GARMENT_TYPE_ENUM[Math.floor(Math.random()*GARMENT_TYPE_ENUM.length)];
                jQuery.ajax({
                    type: 'GET',
                    'url': "webresources/alteration/find?garment=" + garment + "&token=" + token,
                    dataType: "json",
                    'success': function(alterations) {
                        var alteration = alterations.data[Math.floor(Math.random()*alterations.data.length)];
                        createdOrder.createdDateTime = ISODateString(new Date(createdOrder.createdDateTime));
                        createdOrder.dueDateTime = ISODateString(new Date(createdOrder.dueDateTime));
                        createdOrder.garments = [
                            {garmentId:(Math.random()*10000).toFixed(0).toString(), "status":orderStatus,"new":(Math.random() > 0.5),"note":null,"childSize":(Math.random() > 0.5),"formatWare":(Math.random() > 0.5),"garmentType":garment,"purchasedAtTMW":(Math.random() > 0.5),
                                "orderedAlterations":[{"quantity":1,"alteration":alteration}]}];
                        $.postJSON("webresources/order/update/" + token, createdOrder, function(orderDetail) {
                            jQuery.ajax({type: 'GET','url': "webresources/order/schedule?id=" + createdOrder.id + "&token=" + token, dataType: "json"});
                            $("#lastCreatedId").text("Last Updated Order ID:" +orderDetail.data.orderId);
                        });
                    }
                });

            });

        });

    }

    function deleteOrderDetail() {
        if (orderDetails && orderDetails.length > 0) {
            var randomIndex = Math.floor(Math.random()*orderDetails.length);
            var id = orderDetails[randomIndex].id;
            $.postJSON('webresources/order/delete/' +id+"/" + token,
                    function(data) {
                        $("#lastDeletedId").text("Last Deleted Order ID:"+id);
                    }
            );
            if ($("#delete").attr("checked") === "checked") {
                setTimeout(function() {
                    deleteOrderDetail();
                },$("#deleteTimeout").val());
            }
        }
    }

    function searchOrderDetails() {
        $.postJSON("webresources/order/search/" + token, {orderStatus:$("#orderStatus").val()}, function(orderDetail) {
            orderDetails = orderDetail.data.orderSummary;
            $("#totalNumber").text("Total number of orders:"+orderDetail.data.totalCount);
        });
        if ($("#getAll").attr("checked") === "checked") {
            setTimeout(function() {
                searchOrderDetails();
            },$("#getAllTimeout").val());
        }
    }

    function fullDBExport() {
        jQuery.ajax({
            type: 'PUT',
            url: "webresources/orderDetail/search"});
    }

    function login(){
        $.postJSON("webresources/auth/login", {userId:"demo", password:"demo"}, function(response) {
            token = response.data.token;
            $("#loginResult").text("Logged in:"+response.data.token);
            $("#logoutResult").text("");
        });
    }

    function logout(){
        $.getJSON("webresources/auth/logout?token=" + token, function(response) {
            $("#logoutResult").text("Logged out:"+response.status);
            $("#loginResult").text("");
        });
    }

    $(function() {
        for (var i=0;i<ORDER_STATUS_ENUM.length;i++){
            $("#orderStatus").append($("<OPTION>").val(ORDER_STATUS_ENUM[i]).text(ORDER_STATUS_ENUM[i]));
        }
        $("#create").click(createOrderDetail);
        $("#delete").click(deleteOrderDetail);
        $("#getAll").click(searchOrderDetails);
        $("#login").click(login);
        $("#logout").click(logout);
    });
</script>
<body>
<h2>The Tracking Service</h2>
<div id="log"></div>
<div><button id="login">Login</button><span id="loginResult"></span></div>
<br/>
<div><button id="logout">Logout</button><span id="logoutResult"></span></div>
<br/>
<div><div><button id="create">Create Demo Order</button></div> <span id="lastCreatedId"></span></div>
<br/>
<div><input type="checkbox" id="getAll"/>Search by <select id="orderStatus"><option value="">ALL</option></select> every <input id="getAllTimeout" value="10000"/> milliseconds. <span id="totalNumber"></span></div>
<div><input type="checkbox" id="delete"/>Delete Order Detail every <input id="deleteTimeout" value="15000"/> milliseconds. <span id="lastDeletedId"></span></div>

</body>
</html>
